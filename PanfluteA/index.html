



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://pages.charlesreid1.com/translate-yer-docs/PanfluteA/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.2">
    
    
      
        <title>Panflute: Part 1 - translate-yer-docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.8d40d89b.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#panflute-filter-translate" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://pages.charlesreid1.com/translate-yer-docs" title="translate-yer-docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon">insert_drive_file arrow_right_alt g_translate arrow_right_alt insert_drive_file</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                translate-yer-docs
              </span>
              <span class="md-header-nav__topic">
                Panflute: Part 1
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://git.charlesreid1.com/charlesreid1/translate-yer-docs" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      translate-yer-docs
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">insert_drive_file arrow_right_alt g_translate arrow_right_alt insert_drive_file</i>
      
    </span>
    translate-yer-docs
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://git.charlesreid1.com/charlesreid1/translate-yer-docs" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      translate-yer-docs
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Organization/" title="Organization" class="md-nav__link">
      Organization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PandocA/" title="Pandoc: Part 1" class="md-nav__link">
      Pandoc: Part 1
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PandocB/" title="Pandoc: Part 2" class="md-nav__link">
      Pandoc: Part 2
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Panflute: Part 1
      </label>
    
    <a href="./" title="Panflute: Part 1" class="md-nav__link md-nav__link--active">
      Panflute: Part 1
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#panflute-filter-translate" title="Panflute Filter: Translate" class="md-nav__link">
    Panflute Filter: Translate
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PanfluteB/" title="Panflute: Part 2" class="md-nav__link">
      Panflute: Part 2
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PandocC/" title="Pandoc: Part 3" class="md-nav__link">
      Pandoc: Part 3
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Links/" title="Links" class="md-nav__link">
      Links
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#panflute-filter-translate" title="Panflute Filter: Translate" class="md-nav__link">
    Panflute Filter: Translate
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Panflute: Part 1</h1>
                
                <h2 id="panflute-filter-translate">Panflute Filter: Translate<a class="headerlink" href="#panflute-filter-translate" title="Permanent link">&para;</a></h2>
<p>To translate Markdown text to Russian, we want to look for 
Para (paragraph) components, and extract the text from 
each paragraph as a string.</p>
<div class="codehilite"><pre><span></span>cat shepherd.md | pandoc -t json -f gfm -s | filters/translate.py
</pre></div>


<p>The <code>translate.py</code> panflute filter determines what text to translate
and calls the Google Cloud Translate API to do the translating.</p>
<p>We use the Google Cloud Translate API using a Python client library
that they provide, rather than fussing with assembling our own 
payloads and using the <code>requests</code> library.</p>
<p><strong><code>filters/translate.py</code>:</strong></p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">panflute</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">translate</span>


<span class="k">def</span> <span class="nf">translate_document</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">doc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">run_filter</span><span class="p">(</span><span class="n">translate_document</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p>When we run this, it passes each document element through
<code>translate_document()</code>. </p>
<p>Two things we wnat to do up front:</p>
<ul>
<li>
<p>Extract links (these are problematic for translation, 
    we deal with them by removing the link from the inline text
    and including a list at the bottom of the document of 
    the (translated) original link text, plus the link itself.</p>
</li>
<li>
<p>Search for paragraphs of text, or headings, and replace text
    with a translation.</p>
</li>
</ul>
<p>To do the first, we define a function called <code>strip_links()</code>, 
which will strip out all the links and add them to the bottom 
of the document (more on this in a minute).</p>
<p>We pass this function to <code>elem.walk()</code> to apply it to every
element underneath the current element. This means we can 
write the <code>strip_links()</code> function in a similar way to the 
<code>translate_document()</code> function: look for specific types of
elements, and modify them accordingly.</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">translate_document</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>

    <span class="c1"># Walk it and look for links first</span>
    <span class="n">elem</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">strip_links</span><span class="p">)</span>

    <span class="o">...</span>
</pre></div>


<p>Another thing we want to do is translate paragraph text from
Russian to English. We use stringify to turn a list of Str 
and Space objects into a regular string:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">translate_document</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>

    <span class="c1"># Walk it and look for links first</span>
    <span class="n">elem</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">strip_links</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">==</span><span class="n">Para</span><span class="p">:</span>
        <span class="n">english</span> <span class="o">=</span> <span class="n">stringify</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="n">english_to_X</span><span class="p">(</span><span class="n">english</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>


<p>The <code>english_to_X()</code> function (more on this shortly) will use
the Google Cloud Translate API to translate English to our language of choice.
This requires an API key with Google Cloud (see <a href="../Setup/">Setup</a>).</p>
<p>The translate function will return unicode text. This must be turned back into
structured text that pandoc understands, so we have to wrap words in Str()
and replace spaces with Space objects.</p>
<p>To do this easily with a string in panflute, use <code>convert_text()</code>:</p>
<div class="codehilite"><pre><span></span>        english = stringify(elem)
        rooskie = english_to_russian(english)
        new_elems = convert_text(rooskie,input_format=&#39;markdown&#39;)
        return new_elems
</pre></div>


<p>To get Google Cloud Translate API working properly, 
you must export an environment variable <code>$GOOGLE_APPLICATION_CREDENTIALS</code>
that points to a JSON file with your API keys
EACH TIME YOU RUN THE SCRIPT!!!</p>
<div class="codehilite"><pre><span></span>############################################
############################################
##############                ##############
##############   NOTE         ##############
##############                ##############
##
## This step is required for the translate
## API calls to work. Don&#39;t leave this out.
##
############################################
############################################

export GOOGLE_APPLICATION_CREDENTIALS=/path/to/project-key-00000.json
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../PandocB/" title="Pandoc: Part 2" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Pandoc: Part 2
              </span>
            </div>
          </a>
        
        
          <a href="../PanfluteB/" title="Panflute: Part 2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Panflute: Part 2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="https://charlesreid1.com">Charles Reid</a>, released under the <a href="https://opensource.org/licenses/MIT">MIT License</a>.
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.0cf9b500.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:".."}})</script>
      
        <script src="../search/require.js"></script>
      
        <script src="../search/search.js"></script>
      
    
    
      
    
  </body>
</html>